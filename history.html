<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISTORY | Professional Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        body { background-color: #070d1c; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .game-card { background: linear-gradient(180deg, #161e2d 0%, #0a0f1a 100%); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.7); }
        .swiper { width: 100%; padding-top: 30px; padding-bottom: 50px; }
        .swiper-slide { width: 320px; opacity: 0.3; transition: opacity 0.4s ease; }
        .swiper-slide-active { opacity: 1; }
        .score-font { font-family: 'Roboto Mono', monospace; }
        .rank-gold { color: #facc15; }
        .rank-silver { color: #cbd5e1; }
        .list-item-card { background: rgba(255, 255, 255, 0.03); border-left: 3px solid #f97316; }

        /* モーダルアニメーション */
        #detail-modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); }
        #detail-modal.active { transform: translateY(0); }
    </style>
</head>
<body class="pb-24">
    <div class="max-w-4xl mx-auto p-4">
        <header class="mb-10 pt-6">
            <span class="text-[10px] text-orange-500 font-black tracking-[0.3em] uppercase block mb-1">Data Archive</span>
            <h1 class="text-3xl font-black italic uppercase tracking-tighter border-b-2 border-orange-500 inline-block leading-none pb-1">Session History</h1>
        </header>

        <section class="mb-12">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper" id="history-swiper-wrapper"></div>
                <div class="swiper-pagination"></div>
            </div>
        </section>

        <section>
            <h2 class="text-[10px] font-bold text-slate-500 mb-6 uppercase tracking-[0.2em] px-2 border-l-2 border-orange-500 ml-2">All Logs</h2>
            <div id="history-list" class="space-y-6 px-2"></div>
        </section>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-50 bg-[#070d1c] overflow-y-auto">
        <div class="sticky top-0 bg-[#070d1c]/90 backdrop-blur-md p-4 border-b border-white/10 flex justify-between items-center">
            <div>
                <span id="modal-date" class="text-[10px] text-orange-500 font-bold uppercase">DATE</span>
                <h2 class="text-xl font-black italic uppercase tracking-tighter">Box Score</h2>
            </div>
            <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-white/5 w-10 h-10 rounded-full flex items-center justify-center font-bold">×</button>
        </div>
        
        <div id="modal-content" class="p-4 space-y-8">
            </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="navbar.js"></script>

    <script>
        const S_URL = 'https://zekfibkimvsfbnctwzti.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla2ZpYmtpbXZzZmJuY3R3enRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODU5NjYsImV4cCI6MjA4NDE2MTk2Nn0.AjW_4HvApe80USaHTAO_P7WeWaQvPo3xi3cpHm4hrFs';
        const sb = window.supabase.createClient(S_URL, S_KEY);

                async function initHistory() {
            try {
                const { data: sessionData, error } = await sb.from('set_summaries').select('*').order('created_at', { ascending: false });
                if (error) throw error;

                // --- 修正ポイント1: game_id でグルーピングする ---
                // 日付だと秒単位のズレで別人扱いになるため、確実に同じセッションを指す game_id を使います
                const sessions = {};
                sessionData.forEach(row => {
                    const gId = row.game_id;
                    if (!sessions[gId]) sessions[gId] = [];
                    sessions[gId].push(row);
                });

                const swiperWrapper = document.getElementById('history-swiper-wrapper');
                const historyList = document.getElementById('history-list');

                                // --- 修正ポイント：reverse() を追加して降順（新しい順）にする ---
                const sessionIds = Object.keys(sessions).reverse();

                sessionIds.forEach((gId, index) => {
                    const sessionRows = sessions[gId];
                    // スコア順に並び替えてリアルタイムに順位を振る
                    sessionRows.sort((a, b) => b.total_score - a.total_score);
                    
                    // 表示用の日付
                    const date = new Date(sessionRows[0].created_at).toLocaleDateString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit' });
                    
                    const cardHtml = createSessionCard(sessionRows, date, gId);

                    // Swiper（直近5セッション）
                    if (index < 5) {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = cardHtml;
                        swiperWrapper.appendChild(slide);
                    }
                    
                    // All Logs（全履歴を新しい順に）
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item-card p-4 rounded-r-lg mb-6'; 
                    listItem.innerHTML = cardHtml;
                    historyList.appendChild(listItem);
                });


                new Swiper(".mySwiper", {
                    effect: "coverflow",
                    centeredSlides: true,
                    slidesPerView: "auto",
                    coverflowEffect: { rotate: 35, stretch: 0, depth: 100, modifier: 1, slideShadows: false },
                    pagination: { el: ".swiper-pagination", clickable: true },
                });
            } catch (e) { console.error(e); }
        }

        // 引数に sessionId (game_id) を追加
        function createSessionCard(players, date, sessionId) {
            return `
                <div class="game-card p-5" onclick="showSessionDetail('${sessionId}', '${date}')">
                    <div class="flex justify-between items-start mb-5">
                        <div>
                            <span class="text-[9px] text-orange-500 font-black tracking-widest uppercase">Daily Result</span>
                            <h3 class="text-xl font-black italic tracking-tighter leading-none">${date}</h3>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${players.map((p, i) => {
                            const rank = i + 1; // 0位を排除し、1,2,3,4位を割り振る
                            return `
                            <div class="flex items-center justify-between border-b border-white/5 pb-1">
                                <div class="flex items-center space-x-3">
                                    <span class="text-base font-black italic w-4 ${rank === 1 ? 'rank-gold' : 'text-slate-500'}">${rank}</span>
                                    <span class="text-xs font-bold text-slate-200">${p.player_name}</span>
                                </div>
                                <span class="text-sm score-font font-black ${p.total_score >= 0 ? 'text-blue-400' : 'text-red-400'}">
                                    ${p.total_score > 0 ? '+' : ''}${p.total_score}
                                </span>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
        }


                window.showSessionDetail = async function(gId, date) {
    const modal = document.getElementById('detail-modal');
    const content = document.getElementById('modal-content');
    const dateLabel = document.getElementById('modal-date');
    
    dateLabel.innerText = date;
    content.innerHTML = "<div class='p-10 text-center animate-pulse text-[10px] tracking-widest'>FETCHING BOX SCORE...</div>";
    modal.classList.add('active');

    try {
        const { data: summary, error: sError } = await sb.from('set_summaries').select('*').eq('game_id', gId);
        const { data: matches, error: mError } = await sb.from('game_results').select('*').eq('game_id', gId).order('created_at', { ascending: true });

        if (sError || mError) throw (sError || mError);
        content.innerHTML = "";

        // --- SECTION 1: SESSION PAYOUT (競技・精算サマリー) ---
        const summarySorted = summary.sort((a, b) => b.total_score - a.total_score);
        let summaryHtml = `
            <section class="mb-10">
                <h3 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-4 border-l-2 border-orange-500 pl-2">Session Payout</h3>
                <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                    <table class="w-full text-left border-collapse text-[11px]">
                        <thead>
                            <tr class="bg-white/10 text-[9px] text-slate-400 uppercase">
                                <th class="p-3">Player</th>
                                <th class="p-3 text-right">Pts</th>
                                <th class="p-3 text-right text-slate-300">Chips</th> <th class="p-3 text-right text-orange-400 font-black">Coin</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summarySorted.map(s => `
                                <tr class="border-b border-white/5 last:border-0">
                                    <td class="p-3 font-bold text-white uppercase tracking-tighter">${s.player_name}</td>
                                    <td class="p-3 text-right font-mono ${s.total_score >= 0 ? 'text-blue-400' : 'text-red-400'}">${s.total_score > 0 ? '+' : ''}${s.total_score}</td>
                                    <td class="p-3 text-right font-mono text-slate-300">${s.tips > 0 ? '+' : ''}${s.tips}</td> <td class="p-3 text-right font-mono font-black text-orange-500">¥${s.coins.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </section>`;
        content.innerHTML += summaryHtml;

        // --- SECTION 2: MATCH LOGS (半荘別スコア明細) ---
        const grouped = [];
        for (let i = 0; i < matches.length; i += 4) {
            grouped.push(matches.slice(i, i + 4));
        }

        let logsHtml = `<h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 border-l-2 border-slate-500 pl-2">Match Logs</h3>`;
        
        grouped.forEach((players, i) => {
            players.sort((a, b) => a.rank - b.rank);
            logsHtml += `
                <div class="bg-white/5 rounded-lg overflow-hidden border border-white/10 mb-6">
                    <div class="bg-white/10 px-4 py-2 flex justify-between items-center border-b border-white/5">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 italic">Match #${i+1}</span>
                        <span class="text-[9px] text-slate-600 font-mono">${new Date(players[0].created_at).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <table class="w-full text-left border-collapse text-[11px]">
                        <tbody>
                            ${players.map(p => `
                                <tr class="border-b border-white/5 last:border-0">
                                    <td class="p-3 w-8 text-lg font-black italic ${p.rank==1?'text-yellow-400': (p.rank==4?'text-red-500':'text-slate-600')}">${p.rank}</td>
                                    <td class="p-3 font-bold text-slate-200 uppercase">${p.player_name}</td>
                                    <td class="p-3 text-right font-mono font-bold ${p.score>=0?'text-blue-400':'text-red-400'}">
                                        ${p.score > 0 ? '+' : ''}${p.score}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        });
        content.innerHTML += logsHtml;

    } catch (e) { 
        console.error(e);
        content.innerHTML = "<div class='p-10 text-red-500 text-center text-xs tracking-widest'>DATA ARCHIVE ERROR</div>"; 
    }
}




        window.closeModal = function() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        initHistory();
    </script>
</body>
</html>
